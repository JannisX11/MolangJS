!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Molang=t()}(this,(function(){"use strict";const e=e=>((e+180)%360+180)%360;var t={clamp:(e,t,r)=>(e>r&&(e=r),(e<t||isNaN(e))&&(e=t),e),random:(e,t)=>e+Math.random()*(t-e),randomInt:(e,t)=>(e=Math.ceil(e),t=Math.floor(t),e+Math.floor(Math.random()*(t-e+1))),dieRoll(e,t,r){e=this.clamp(e,0,1e9);let n=0;for(var a=0;a<e;a++)n+=this.random(t,r);return n},dieRollInt(e,t,r){e=this.clamp(e,0,1e9);let n=0;for(var a=0;a<e;a++)n+=this.randomInt(t,r);return n},lerp:(e,t,r)=>e+(t-e)*r,lerpRotate(t,r,n){let a=e(t),s=e(r);a>s&&([a,s]=[s,a]);var i=s-a;return i>180?e(s+n*(360-i)):a+n*i},inRange:(e,t,r)=>e<=r&&e>=t?1:0,all:(e,...t)=>-1===t.findIndex((t=>t!==e))?1:0,any:(e,...t)=>t.findIndex((t=>t==e))>=0?1:0,approxEq:(e,...t)=>-1===t.findIndex((t=>Math.abs(e-t)>1e-7))?1:0};return function(){const e=this;this.global_variables={},this.cache_enabled=!0,this.use_radians=!1,this.variables={},this.variableHandler=null;let r={},n=!1,a={};function s(e){let t=e.replace(/\s/g,"");if(-1===t.indexOf(";"))this.lines=[g(t)];else{this.lines=[];let e=t.split(";");for(let t of e){if(!t)continue;let e=g(t);if(this.lines.push(e),e instanceof c)break}}}function i(e,t,r,n){this.operator=e,this.a=g(t),void 0!==r&&(this.b=g(r)),void 0!==n&&(this.c=g(n))}function u(e,t){this.query=e,this.args=t.map((e=>g(e)))}function l(e,t){this.value=g(t),this.name=e}function c(e){this.value=g(e)}let o=()=>this.use_radians?1:Math.PI/180,f=/^-?\d+(\.\d+)?$/;function h(e){return f.test(e)}const b=/[^a-z0-9\.]/,d=/(temp|variable)\.\w+=/;function g(e){if(!e)return 0;if(h(e))return parseFloat(e);for(;p(e);)e=e.substr(1,e.length-2);if(e.startsWith("return"))return new c(e.substr(6));switch(e){case"true":return 1;case"false":return 0}if("."===e.substring(1,2)){switch(e.substring(0,1)){case"q":e="query"+e.substring(1);break;case"v":e="variable"+e.substring(1);break;case"t":e="temp"+e.substring(1);break;case"c":e="context"+e.substring(1)}}if(b.test(e)){let t=e.length>4&&e.match(d);if(t&&"="!==e[t.index+t[0].length]){return new l(t[0].substring(0,t[0].length-1),e.substr(t.index+t[0].length))}let r=w(e,"??",19);if(r)return r;let n=m(e,"?");if(n){let e=m(n[1],":");return e&&e.length?new i(10,n[0],e[0],e[1]):new i(10,n[0],n[1],0)}if(r=w(e,"&&",11)||w(e,"||",12)||w(e,"<=",14)||w(e,"<",13)||w(e,">=",16)||w(e,">",15)||w(e,"==",17)||w(e,"!=",18)||w(e,"+",1,!0)||function(e,t,r){let n=y(e,t);if(n)return 0===n[0].length?new i(r,0,n[1]):new i(r,n[0],n[1])}(e,"-",2)||w(e,"*",3)||w(e,"/",4,!0)||function(e){if(e.startsWith("!")&&e.length>1)return new i(5,e.substr(1),0)}(e),r instanceof i)return r;if(e.startsWith("math.")){if("math.pi"===e)return Math.PI;let t=e.indexOf("("),r=e.substr(5,t-5),n=e.substr(t+1,e.length-t-2),a=m(n,",")||[n];if(a.length>1){let e=m(a[1],",");e&&e.length>1&&(a[1]=e[0],a[2]=e[1])}switch(r){case"abs":return new i(100,a[0]);case"sin":return new i(101,a[0]);case"cos":return new i(102,a[0]);case"exp":return new i(103,a[0]);case"ln":return new i(104,a[0]);case"pow":return new i(105,a[0],a[1]);case"sqrt":return new i(106,a[0]);case"random":return new i(107,a[0],a[1]);case"ceil":return new i(108,a[0]);case"round":return new i(109,a[0]);case"trunc":return new i(110,a[0]);case"floor":return new i(111,a[0]);case"mod":return new i(112,a[0],a[1]);case"min":return new i(113,a[0],a[1]);case"max":return new i(114,a[0],a[1]);case"clamp":return new i(115,a[0],a[1],a[2]);case"lerp":return new i(116,a[0],a[1],a[2]);case"lerprotate":return new i(117,a[0],a[1],a[2]);case"asin":return new i(118,a[0]);case"acos":return new i(119,a[0]);case"atan":return new i(120,a[0]);case"atan2":return new i(121,a[0],a[1]);case"die_roll":return new i(122,a[0],a[1],a[2]);case"die_roll_integer":return new i(123,a[0],a[1],a[2]);case"hermite_blend":return new i(124,a[0]);case"random_integer":return new i(125,a[0],a[1],a[2])}}}let t=e.match(/[a-z0-9._]{2,}/g);if(t&&1===t.length&&t[0].length>=e.length-2)return e;if(e.includes("(")&&")"==e[e.length-1]){let t,r=e.search(/\(/),n=e.substr(0,r),a=[e.substr(r+1,e.length-r-2)];for(;t=m(a[a.length-1],",");)a.splice(a.length-1,1,...t);return new u(n,a)}return 0}function p(e){if(e.startsWith("(")&&e.endsWith(")")){let t=0;for(let r=0;r<e.length-1;r++){switch(e[r]){case"(":t++;break;case")":t--}if(0==t)return!1}return!0}}function w(e,t,r,n){let a=n?y(e,t):m(e,t);if(a)return new i(r,a[0],a[1])}function m(e,t){if(-1===e.indexOf(t))return;let r=0;for(let n=0;n<e.length;n++)switch(e[n]){case"(":r++;break;case")":r--;break;default:if(0===r&&t[0]===e[n]&&(1===t.length||t===e.substr(n,t.length)))return[e.substr(0,n),e.substr(n+t.length)]}}function y(e,t){if(-1===e.indexOf(t))return;let r=e.length-1,n=0;for(;r>=0;){switch(e[r]){case"(":n--;break;case")":n++;break;default:if(!(0!==n||t[0]!==e[r]||1!==t.length&&t!==e.substr(r,t.length)||"-"===t&&!1!=="+*/<>=|&?:".includes(e[r-1])))return[e.substr(0,r),e.substr(r+t.length)]}r--}}function v(e,t){return"string"==typeof e&&"'"==e[0]||(e=M(e,!0)),"string"==typeof t&&"'"==t[0]||(t=M(t,!0)),e===t}function M(a,s){if("number"==typeof a)return a;if(a instanceof i)switch(a.operator){case 1:return M(a.a)+M(a.b);case 2:return M(a.a)-M(a.b);case 3:return M(a.a)*M(a.b);case 4:return M(a.a)/M(a.b);case 5:return 0==M(a.a)?1:0;case 10:return M(a.a)?M(a.b):M(a.c);case 11:return M(a.a)&&M(a.b)?1:0;case 12:return M(a.a)||M(a.b)?1:0;case 13:return M(a.a)<M(a.b)?1:0;case 14:return M(a.a)<=M(a.b)?1:0;case 15:return M(a.a)>M(a.b)?1:0;case 16:return M(a.a)>=M(a.b)?1:0;case 17:return v(a.a,a.b)?1:0;case 18:return v(a.a,a.b)?0:1;case 19:n=!1;let e=M(a.a);return n?M(a.b):e;case 100:return Math.abs(M(a.a));case 101:return Math.sin(M(a.a)*o());case 102:return Math.cos(M(a.a)*o());case 103:return Math.exp(M(a.a));case 104:return Math.log(M(a.a));case 105:return Math.pow(M(a.a),M(a.b));case 106:return Math.sqrt(M(a.a));case 107:return t.random(M(a.a),M(a.b));case 108:return Math.ceil(M(a.a));case 109:return Math.round(M(a.a));case 110:return Math.trunc(M(a.a));case 111:return Math.floor(M(a.a));case 112:return M(a.a)%M(a.b);case 113:return Math.min(M(a.a),M(a.b));case 114:return Math.max(M(a.a),M(a.b));case 115:return t.clamp(M(a.a),M(a.b),M(a.c));case 116:return t.lerp(M(a.a),M(a.b),M(a.c));case 117:return t.lerpRotate(M(a.a),M(a.b),M(a.c));case 118:return Math.asin(M(a.a))/o();case 119:return Math.acos(M(a.a))/o();case 120:return Math.atan(M(a.a))/o();case 121:return Math.atan2(M(a.a),M(a.b))/o();case 122:return t.dieRoll(M(a.a),M(a.b),M(a.c));case 123:return t.dieRollInt(M(a.a),M(a.b),M(a.c));case 124:let r=M(a.a);return 3*Math.pow(r,2)-2*Math.pow(r,3);case 125:return t.randomInt(M(a.a),M(a.b))}else{if("string"==typeof a){let t=r[a];if(void 0===t&&"function"==typeof e.variableHandler&&(t=e.variableHandler(a,r)),"number"==typeof t)return t;if("string"==typeof t&&!s)return e.parse(t,r)||0;if(void 0===t)n=!0;else if("function"==typeof t)return t()||0;return t||0}if(a instanceof c)return M(a.value);if(a instanceof l)return r[a.name]=e.variables[a.name]=M(a.value);if(a instanceof u){let n=a.args.map((e=>M(e)));switch(a.query){case"query.in_range":return t.inRange(...n);case"query.all":return t.all(...n);case"query.any":return t.any(...n);case"query.approx_eq":return t.approxEq(...n)}return"function"==typeof r[a.query]?r[a.query](...n):"function"==typeof e.variableHandler?e.variableHandler(a.query,r,n):0}}return 0}this.parse=(t,n)=>{if("number"==typeof t)return isNaN(t)?0:t;if("string"!=typeof t||0===t.length)return 0;if((t=t.toLowerCase().trim()).length<9&&h(t))return parseFloat(t);let i=this.cache_enabled&&a[t];return i||(i=new s(t),this.cache_enabled&&function(e,t){a[e]=t}(t,i)),function(t,n){for(let t in e.global_variables)r[t]=e.global_variables[t];for(let t in e.variables)r[t]=e.variables[t];if(n)for(let e in n)r[e]=n[e];if(1===t.lines.length){let e=M(t.lines[0]);return r={},e}let a=0;for(let e of t.lines)a=M(e);return r={},a}(i,n)},this.resetVariables=()=>{e.variables={}}}}));
