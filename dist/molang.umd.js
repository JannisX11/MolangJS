!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Molang=t()}(this,(function(){"use strict";const e=e=>((e+180)%360+180)%360;var t={clamp:(e,t,r)=>(e>r&&(e=r),(e<t||isNaN(e))&&(e=t),e),random:(e,t)=>e+Math.random()*(t-e),randomInt:(e,t)=>(e=Math.ceil(e),t=Math.floor(t),e+Math.floor(Math.random()*(t-e+1))),dieRoll(e,t,r){e=this.clamp(e,0,1e9);let n=0;for(var a=0;a<e;a++)n+=this.random(t,r);return n},dieRollInt(e,t,r){e=this.clamp(e,0,1e9);let n=0;for(var a=0;a<e;a++)n+=this.randomInt(t,r);return n},lerp:(e,t,r)=>e+(t-e)*r,lerpRotate(t,r,n){let a=e(t),s=e(r);a>s&&([a,s]=[s,a]);var i=s-a;return i>180?e(s+n*(360-i)):a+n*i},inRange:(e,t,r)=>e<=r&&e>=t?1:0,all:(e,...t)=>-1===t.findIndex((t=>t!==e))?1:0,any:(e,...t)=>t.findIndex((t=>t==e))>=0?1:0,approxEq:(e,...t)=>-1===t.findIndex((t=>Math.abs(e-t)>1e-7))?1:0};return function(){const e=this;this.global_variables={},this.cache_enabled=!0,this.use_radians=!1,this.variables={},this.variableHandler=null;let r={},n=!1,a=0,s={};function i(e){this.lines=[];for(let t of e){if(!t)continue;let e=y(t);if(this.lines.push(e),e instanceof f)break}}function u(e,t){this.iterations=y(e),this.body=y(t)}function c(e,t,r,n){this.operator=e,this.a=y(t),void 0!==r&&(this.b=y(r)),void 0!==n&&(this.c=y(n))}function l(e,t){this.query=e,this.args=t.map((e=>y(e)))}function o(e,t){this.value=y(t),this.name=e}function f(e){this.value=y(e)}function h(){}function b(){}let d=()=>this.use_radians?1:Math.PI/180,g=/^-?\d+(\.\d+)?$/;function p(e){return g.test(e)}const w=/[^a-z0-9\.]/,m=/(temp|variable)\.\w+=/;function y(e){if(!e)return 0;if(p(e))return parseFloat(e);for(;v(e);)e=e.substr(1,e.length-2);let t=I(e,";",!0);if(t)return new i(t);if(e.startsWith("return"))return new f(e.substr(6));switch(e){case"true":return 1;case"false":return 0;case"break":return new h;case"continue":return new b}if("."===e.substring(1,2)){switch(e.substring(0,1)){case"q":e="query"+e.substring(1);break;case"v":e="variable"+e.substring(1);break;case"t":e="temp"+e.substring(1);break;case"c":e="context"+e.substring(1)}}if(w.test(e)){let t=-1!==e.indexOf("="),r=-1!==e.indexOf("?"),n=t&&e.length>4&&e.match(m);if(n&&"="!==e[n.index+n[0].length]){return new o(n[0].substring(0,n[0].length-1),e.substr(n.index+n[0].length))}let a=r&&M(e,"??",19);if(a)return a;let s=r&&I(e,"?");if(s){let e=I(s[1],":");return e&&e.length?new c(10,s[0],e[0],e[1]):new c(10,s[0],s[1],0)}if(a=M(e,"&&",11)||M(e,"||",12)||t&&M(e,"<=",14)||M(e,"<",13)||t&&M(e,">=",16)||M(e,">",15)||t&&M(e,"==",17)||t&&M(e,"!=",18)||M(e,"+",1,!0)||function(e,t,r){let n=R(e,t);if(n)return 0===n[0].length?new c(r,0,n[1]):new c(r,n[0],n[1])}(e,"-",2)||M(e,"*",3)||M(e,"/",4,!0)||function(e){if(e.startsWith("!")&&e.length>1)return new c(5,e.substr(1),0)}(e),a instanceof c)return a;if(e.startsWith("math.")){if("math.pi"===e)return Math.PI;let t=e.indexOf("("),r=e.substr(5,t-5),n=e.substr(t+1,e.length-t-2),a=I(n,",",!0);switch(a||(a=[n]),r){case"abs":return new c(100,a[0]);case"sin":return new c(101,a[0]);case"cos":return new c(102,a[0]);case"exp":return new c(103,a[0]);case"ln":return new c(104,a[0]);case"pow":return new c(105,a[0],a[1]);case"sqrt":return new c(106,a[0]);case"random":return new c(107,a[0],a[1]);case"ceil":return new c(108,a[0]);case"round":return new c(109,a[0]);case"trunc":return new c(110,a[0]);case"floor":return new c(111,a[0]);case"mod":return new c(112,a[0],a[1]);case"min":return new c(113,a[0],a[1]);case"max":return new c(114,a[0],a[1]);case"clamp":return new c(115,a[0],a[1],a[2]);case"lerp":return new c(116,a[0],a[1],a[2]);case"lerprotate":return new c(117,a[0],a[1],a[2]);case"asin":return new c(118,a[0]);case"acos":return new c(119,a[0]);case"atan":return new c(120,a[0]);case"atan2":return new c(121,a[0],a[1]);case"die_roll":return new c(122,a[0],a[1],a[2]);case"die_roll_integer":return new c(123,a[0],a[1],a[2]);case"hermite_blend":return new c(124,a[0]);case"random_integer":return new c(125,a[0],a[1],a[2])}}if(e.startsWith("loop(")){let t=I(e.substring(5,e.length-1),",",!0);if(t)return new u(...t)}}let r=e.match(/[a-z0-9._]{2,}/g);if(r&&1===r.length&&r[0].length>=e.length-2)return e;if(e.includes("(")&&")"==e[e.length-1]){let t=e.search(/\(/),r=e.substr(0,t),n=e.substr(t+1,e.length-t-2),a=I(n,",",!0);return a||(a=[n]),new l(r,a)}return 0}function v(e){if(e.startsWith(x)&&e.endsWith(q)||e.startsWith(_)&&e.endsWith(k)){let t=0;for(let r=0;r<e.length-1;r++){switch(e[r]){case x:case _:t++;break;case q:case k:t--}if(0==t)return!1}return!0}}function M(e,t,r,n){let a=n?R(e,t):I(e,t);if(a)return new c(r,a[0],a[1])}const x="(",q=")",_="{",k="}";function I(e,t,r=!1){if(-1===e.indexOf(t))return;let n,a=0,s=0;e:for(let i=0;i<e.length;i++)switch(e[i]){case x:case _:a++;break;case q:case k:a--;break;default:if(0===a&&t[0]===e[i]&&(1===t.length||t===e.substr(i,t.length))){let a=e.substring(s,i);if(n||(n=[]),n.push(a),s=i+t.length,!r||-1===e.substring(s).indexOf(t))break e}}return n&&n.length?(n.push(e.substring(s)),n):void 0}function R(e,t){if(-1===e.indexOf(t))return;let r=e.length-1,n=0;for(;r>=0;){switch(e[r]){case x:case _:n++;break;case q:case k:n--;break;default:if(!(0!==n||t[0]!==e[r]||1!==t.length&&t!==e.substr(r,t.length)||"-"===t&&!1!=="+*/<>=|&?:".includes(e[r-1])))return[e.substr(0,r),e.substr(r+t.length)]}r--}}function W(e,t){return"string"==typeof e&&"'"==e[0]||(e=O(e,!0)),"string"==typeof t&&"'"==t[0]||(t=O(t,!0)),e===t}function O(s,g){if("number"==typeof s)return s;if("string"==typeof s){let t=r[s];if(void 0===t&&"function"==typeof e.variableHandler&&(t=e.variableHandler(s,r)),"number"==typeof t)return t;if("string"==typeof t&&!g)return e.parse(t,r)||0;if(void 0===t)n=!0;else if("function"==typeof t)return t()||0;return t||0}switch(s.constructor){case c:switch(s.operator){case 1:return O(s.a)+O(s.b);case 2:return O(s.a)-O(s.b);case 3:return O(s.a)*O(s.b);case 4:return O(s.a)/O(s.b);case 5:return 0==O(s.a)?1:0;case 10:return O(s.a)?O(s.b):O(s.c);case 11:return O(s.a)&&O(s.b)?1:0;case 12:return O(s.a)||O(s.b)?1:0;case 13:return O(s.a)<O(s.b)?1:0;case 14:return O(s.a)<=O(s.b)?1:0;case 15:return O(s.a)>O(s.b)?1:0;case 16:return O(s.a)>=O(s.b)?1:0;case 17:return W(s.a,s.b)?1:0;case 18:return W(s.a,s.b)?0:1;case 19:n=!1;let e=O(s.a);return n?O(s.b):e;case 100:return Math.abs(O(s.a));case 101:return Math.sin(O(s.a)*d());case 102:return Math.cos(O(s.a)*d());case 103:return Math.exp(O(s.a));case 104:return Math.log(O(s.a));case 105:return Math.pow(O(s.a),O(s.b));case 106:return Math.sqrt(O(s.a));case 107:return t.random(O(s.a),O(s.b));case 108:return Math.ceil(O(s.a));case 109:return Math.round(O(s.a));case 110:return Math.trunc(O(s.a));case 111:return Math.floor(O(s.a));case 112:return O(s.a)%O(s.b);case 113:return Math.min(O(s.a),O(s.b));case 114:return Math.max(O(s.a),O(s.b));case 115:return t.clamp(O(s.a),O(s.b),O(s.c));case 116:return t.lerp(O(s.a),O(s.b),O(s.c));case 117:return t.lerpRotate(O(s.a),O(s.b),O(s.c));case 118:return Math.asin(O(s.a))/d();case 119:return Math.acos(O(s.a))/d();case 120:return Math.atan(O(s.a))/d();case 121:return Math.atan2(O(s.a),O(s.b))/d();case 122:return t.dieRoll(O(s.a),O(s.b),O(s.c));case 123:return t.dieRollInt(O(s.a),O(s.b),O(s.c));case 124:let r=O(s.a);return 3*Math.pow(r,2)-2*Math.pow(r,3);case 125:return t.randomInt(O(s.a),O(s.b))}break;case f:return a=1,O(s.value);case o:return r[s.name]=e.variables[s.name]=O(s.value);case l:let g=s.args.map((e=>O(e)));switch(s.query){case"query.in_range":return t.inRange(...g);case"query.all":return t.all(...g);case"query.any":return t.any(...g);case"query.approx_eq":return t.approxEq(...g)}return"function"==typeof r[s.query]?r[s.query](...g):"function"==typeof e.variableHandler?e.variableHandler(s.query,r,g):0;case i:a=0;let p=0;for(let e of s.lines)if(p=O(e),a>0)break;return p;case u:let w=0,m=t.clamp(O(s.iterations),0,1024);for(let e=0;e<m;e++){let e=O(s.body);if(2===a){a=0;break}if(3!==a){if(w=e,1===a)break}else a=0}return w;case h:return a=2,0;case b:return a=3,0}return 0}this.parse=(t,n)=>{if("number"==typeof t)return isNaN(t)?0:t;if("string"!=typeof t||0===t.length)return 0;if(t.length<9&&p(t))return parseFloat(t);let i=this.cache_enabled&&s[t];return i||(i=function(e){return y(e=e.toLowerCase().replace(/\s/g,""))}(t),this.cache_enabled&&function(e,t){s[e]=t}(t,i)),function(t,n){for(let t in e.global_variables)r[t]=e.global_variables[t];for(let t in e.variables)r[t]=e.variables[t];if(n)for(let e in n)r[e]=n[e];let s=O(t);return r={},a=0,s}(i,n)},this.resetVariables=()=>{e.variables={}}}}));
