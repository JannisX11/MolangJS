!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Molang=t()}(this,(function(){"use strict";const e=e=>((e+180)%360+180)%360;var t={clamp:(e,t,r)=>(e>r&&(e=r),(e<t||isNaN(e))&&(e=t),e),random:(e,t)=>e+Math.random()*(t-e),randomInt:(e,t)=>(e=Math.ceil(e),t=Math.floor(t),e+Math.floor(Math.random()*(t-e+1))),dieRoll(e,t,r){e=this.clamp(e,0,1e9);let n=0;for(var a=0;a<e;a++)n+=this.random(t,r);return n},dieRollInt(e,t,r){e=this.clamp(e,0,1e9);let n=0;for(var a=0;a<e;a++)n+=this.randomInt(t,r);return n},lerp:(e,t,r)=>e+(t-e)*r,lerpRotate(t,r,n){let a=e(t),s=e(r);a>s&&([a,s]=[s,a]);var u=s-a;return u>180?e(s+n*(360-u)):a+n*u},inRange:(e,t,r)=>e<=r&&e>=t?1:0,all:(e,...t)=>-1===t.findIndex((t=>t!==e))?1:0,any:(e,...t)=>t.findIndex((t=>t==e))>=0?1:0,approxEq:(e,...t)=>-1===t.findIndex((t=>Math.abs(e-t)>1e-7))?1:0};return function(){const e=this;this.global_variables={},this.cache_enabled=!0,this.use_radians=!1,this.variables={},this.variableHandler=null;let r={},n=!1,a=0,s={},u=0;function i(e){this.lines=[];for(let t of e){if(!t)continue;let e=x(t);if(this.lines.push(e),e instanceof h)break}}function c(e,t){this.iterations=x(e),this.body=x(t)}function l(e,t,r,n){this.operator=e,this.a=x(t),void 0!==r&&(this.b=x(r)),void 0!==n&&(this.c=x(n))}function o(e,t){this.query=e,this.args=t.map((e=>x(e)))}function f(e,t){this.value=x(t),this.name=m(e)}function h(e){this.value=x(e)}function b(){}function d(){}let g=()=>this.use_radians?1:Math.PI/180,p=/^-?\d+(\.\d+f?)?$/;function w(e){return p.test(e)}function m(e){if(e[1]!==M)return e;switch(e[0]){case"q":return"query"+e.substring(1);case"v":return"variable"+e.substring(1);case"t":return"temp"+e.substring(1);case"c":return"context"+e.substring(1);default:return e}}const y=/[&|<>=]/,v=/^(temp|variable|t|v)\.\w+=/,M=".";function x(e){if(!e)return 0;for(e.endsWith(";")&&(e=e.substring(0,e.length-1));q(e);)e=e.substr(1,e.length-2);if(w(e))return parseFloat(e);let t=H(e,";");if(t)return new i(t);if(e.startsWith("return"))return new h(e.substr(6));switch(e){case"true":return 1;case"false":return 0;case"break":return new b;case"continue":return new d}let r=-1!==e.indexOf("="),n=r&&e.length>4&&e.match(v);if(n&&"="!==e[n.index+n[0].length]){return new f(n[0].substring(0,n[0].length-1),e.substr(n.index+n[0].length))}let a=-1!==e.indexOf("?"),s=a&&_(e,"??",19);if(s)return s;let u=a&&R(e,"?");if(u){let e=R(u[1],":");return e&&e.length?new l(10,u[0],e[0],e[1]):new l(10,u[0],u[1],0)}if(s=y.test(e)&&(_(e,"&&",11)||_(e,"||",12)||r&&_(e,"==",17)||r&&_(e,"!=",18)||r&&_(e,"<=",14)||_(e,"<",13)||r&&_(e,">=",16)||_(e,">",15))||_(e,"+",1,!0)||function(e,t,r){let n=j(e,t);if(n)return 0===n[0].length?new l(r,0,n[1]):new l(r,n[0],n[1])}(e,"-",2)||_(e,"*",3)||_(e,"/",4,!0)||function(e){if(e.startsWith("!")&&e.length>1)return new l(5,e.substr(1),0)}(e),s instanceof l)return s;if(e.startsWith("math.")){if("math.pi"===e)return Math.PI;let t=e.indexOf("("),r=e.substr(5,t-5),n=e.substr(t+1,e.length-t-2),a=H(n,",");switch(a||(a=[n]),r){case"abs":return new l(100,a[0]);case"sin":return new l(101,a[0]);case"cos":return new l(102,a[0]);case"exp":return new l(103,a[0]);case"ln":return new l(104,a[0]);case"pow":return new l(105,a[0],a[1]);case"sqrt":return new l(106,a[0]);case"random":return new l(107,a[0],a[1]);case"ceil":return new l(108,a[0]);case"round":return new l(109,a[0]);case"trunc":return new l(110,a[0]);case"floor":return new l(111,a[0]);case"mod":return new l(112,a[0],a[1]);case"min":return new l(113,a[0],a[1]);case"max":return new l(114,a[0],a[1]);case"clamp":return new l(115,a[0],a[1],a[2]);case"lerp":return new l(116,a[0],a[1],a[2]);case"lerprotate":return new l(117,a[0],a[1],a[2]);case"asin":return new l(118,a[0]);case"acos":return new l(119,a[0]);case"atan":return new l(120,a[0]);case"atan2":return new l(121,a[0],a[1]);case"die_roll":return new l(122,a[0],a[1],a[2]);case"die_roll_integer":return new l(123,a[0],a[1],a[2]);case"hermite_blend":return new l(124,a[0]);case"random_integer":return new l(125,a[0],a[1])}}if(e.startsWith("loop(")){let t=H(e.substring(5,e.length-1),",");if(t)return new c(...t)}if(u=e.match(/[a-z0-9._]{2,}/g),u&&1===u.length&&u[0].length>=e.length-2)return m(e);if(e.includes("(")&&")"==e[e.length-1]){let t=e.search(/\(/),r=m(e.substr(0,t)),n=e.substr(t+1,e.length-t-2),a=H(n,",");return a||(a=[n]),new o(r,a)}return 0}function q(e){let t=e.startsWith(k)&&e.endsWith(I);if(t||e.startsWith(O)&&e.endsWith(W)){if(e.indexOf(t?I:W)===e.length-1)return!0;let r=0;for(let t=0;t<e.length-1;t++){switch(e[t]){case k:case O:r++;break;case I:case W:r--}if(0==r)return!1}return!0}return!1}function _(e,t,r,n){let a=n?j(e,t):R(e,t);if(a)return new l(r,a[0],a[1])}const k="(",I=")",O="{",W="}";function R(e,t){if(-1===e.indexOf(t))return;let r=0;for(let n=0;n<e.length;n++)switch(e[n]){case k:r++;break;case I:r--;break;default:if(0===r&&t[0]===e[n]&&(1===t.length||t===e.substr(n,t.length)))return[e.substr(0,n),e.substr(n+t.length)]}}function H(e,t){if(-1===e.indexOf(t))return;let r,n=0,a=0;e:for(let s=0;s<e.length;s++)switch(e[s]){case k:case O:n++;break;case I:case W:n--;break;default:if(0===n&&t[0]===e[s]&&(1===t.length||t===e.substr(s,t.length))){let n=e.substring(a,s);if(r||(r=[]),r.push(n),a=s+t.length,-1===e.substring(a).indexOf(t))break e}}return r&&r.length?(r.push(e.substring(a)),r):void 0}function j(e,t){if(-1===e.indexOf(t))return;let r=e.length-1,n=0;for(;r>=0;){switch(e[r]){case k:case O:n++;break;case I:case W:n--;break;default:if(!(0!==n||t[0]!==e[r]||1!==t.length&&t!==e.substr(r,t.length)||"-"===t&&!1!=="+*/<>=|&?:".includes(e[r-1])))return[e.substr(0,r),e.substr(r+t.length)]}r--}}function E(e,t){return"string"==typeof e&&"'"==e[0]||(e=F(e,!0)),"string"==typeof t&&"'"==t[0]||(t=F(t,!0)),e===t}function F(s,u){if("number"==typeof s)return s;if("string"==typeof s){let t=r[s];if(void 0===t&&"function"==typeof e.variableHandler&&(t=e.variableHandler(s,r)),"number"==typeof t)return t;if("string"==typeof t&&!u)return e.parse(t,r)||0;if(void 0===t)n=!0;else if("function"==typeof t)return t()||0;return t||0}if(void 0===s)return 0;switch(s.constructor){case l:switch(s.operator){case 1:return F(s.a)+F(s.b);case 2:return F(s.a)-F(s.b);case 3:return F(s.a)*F(s.b);case 4:return F(s.a)/F(s.b);case 5:return 0==F(s.a)?1:0;case 10:return F(s.a)?F(s.b):F(s.c);case 11:return F(s.a)&&F(s.b)?1:0;case 12:return F(s.a)||F(s.b)?1:0;case 13:return F(s.a)<F(s.b)?1:0;case 14:return F(s.a)<=F(s.b)?1:0;case 15:return F(s.a)>F(s.b)?1:0;case 16:return F(s.a)>=F(s.b)?1:0;case 17:return E(s.a,s.b)?1:0;case 18:return E(s.a,s.b)?0:1;case 19:n=!1;let e=F(s.a);return n?F(s.b):e;case 100:return Math.abs(F(s.a));case 101:return Math.sin(F(s.a)*g());case 102:return Math.cos(F(s.a)*g());case 103:return Math.exp(F(s.a));case 104:return Math.log(F(s.a));case 105:return Math.pow(F(s.a),F(s.b));case 106:return Math.sqrt(F(s.a));case 107:return t.random(F(s.a),F(s.b));case 108:return Math.ceil(F(s.a));case 109:return Math.round(F(s.a));case 110:return Math.trunc(F(s.a));case 111:return Math.floor(F(s.a));case 112:return F(s.a)%F(s.b);case 113:return Math.min(F(s.a),F(s.b));case 114:return Math.max(F(s.a),F(s.b));case 115:return t.clamp(F(s.a),F(s.b),F(s.c));case 116:return t.lerp(F(s.a),F(s.b),F(s.c));case 117:return t.lerpRotate(F(s.a),F(s.b),F(s.c));case 118:return Math.asin(F(s.a))/g();case 119:return Math.acos(F(s.a))/g();case 120:return Math.atan(F(s.a))/g();case 121:return Math.atan2(F(s.a),F(s.b))/g();case 122:return t.dieRoll(F(s.a),F(s.b),F(s.c));case 123:return t.dieRollInt(F(s.a),F(s.b),F(s.c));case 124:let r=F(s.a);return 3*Math.pow(r,2)-2*Math.pow(r,3);case 125:return t.randomInt(F(s.a),F(s.b))}break;case h:return a=1,F(s.value);case f:return r[s.name]=e.variables[s.name]=F(s.value),0;case o:let u=s.args.map((e=>F(e)));switch(s.query){case"query.in_range":return t.inRange(...u);case"query.all":return t.all(...u);case"query.any":return t.any(...u);case"query.approx_eq":return t.approxEq(...u)}return"function"==typeof r[s.query]?r[s.query](...u)||0:"function"==typeof e.variableHandler&&e.variableHandler(s.query,r,u)||0;case i:a=0;let p=0;for(let e of s.lines)if(p=F(e),a>0)break;return p;case c:let w=0,m=t.clamp(F(s.iterations),0,1024);for(let e=0;e<m;e++){let e=F(s.body);if(2===a){a=0;break}if(3!==a){if(w=e,1===a)break}else a=0}return w;case b:return a=2,0;case d:return a=3,0}return 0}this.parse=(t,n)=>{if("number"==typeof t)return t||0;if("string"!=typeof t||0===t.length)return 0;if(t.length<9&&w(t))return parseFloat(t);let i=this.cache_enabled&&s[t];return i||(i=x(t.toLowerCase().replace(/\s/g,"")),this.cache_enabled&&function(e,t){if(s[e]=t,u++,u>400){let e=Object.keys(s);for(let t=0;t<10;t++)delete s[e[t]];u-=10}}(t,i)),function(t,n){for(let t in e.global_variables)r[t]=e.global_variables[t];for(let t in e.variables)r[t]=e.variables[t];if(n)for(let e in n)r[e]=n[e];let s=F(t);return r={},a=0,s}(i,n)||0},this.resetVariables=()=>{e.variables={}}}}));
